{% extends "main.html.twig" %}

{% block header %}

    {% set dish = data %}
    <div class="banner_detail" style="background-image: url('assets/img/{{ dish.image }}');">
        <div class="banner-logo">
            <a href="http://localhost/educom-verrukkulluk-1745327773/indexF.php">
                <img src="assets/img/logo-v2.png" alt="Logo">
            </a>
        </div>
    </div>

{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            {% set dish = data %}
            <div class="dish-detail-card">
                <div class="dish-image">
                    <img src="assets/img/{{ dish.image }}" alt="{{ dish.title }}">
                </div>
                <div class="dish-info">
                    <div class="extra_info">
                        <span class="persons"><i class="fa fa-users"></i> {{ 4 }}</span>
                        <span class="price"><i class="fa fa-euro"></i> {{ dish.Price|default('-') }}</span>
                        <span class="calories"><i class="fa fa-fire"></i> {{ dish.Calories|default('-') }}</span>
                    </div>
                    <div class="dish_header">
                        <h2>{{ dish.title }}</h2>
                        {# rating! #}
                        <div class="ster">
                            <div class="rating interactive-rating">
                                {% for i in 1..5 %}
                                    <span class="star" data-value="{{ i }}"><i class="fa fa-star"></i></span>
                                {% endfor %}
                            </div>
                            <div id="rating-message"></div>
                        </div>
                    </div>
                    <div class="details-row">
                        <span class="label"><h3>Keuken</h3></span>
                        <span class="value">{{ dish.Kitchen.description|default('-') }}</span>
                        <span class="label type-label"><h3>Type</h3></span>
                        <span class="value">{{ dish.Type.description|default('-') }}</span>
                    </div>
                    <p class="long-description">{{ dish.long_description }}</p>
                    <div class="footer_card">
                        <div class="smullenbtn">
                            <a href="indexF.php?action=grocery_list&dish_id={{ dish.id }}" class="smullen-button">Op Lijst</a>
                        </div>
                        <div class="heart-icon">
                            <i id="favorite-heart" class="fa fa-heart-o"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="tabs">
                <input type="radio" id="ingredients" name="tabs" checked>
                <label for="ingredients"><h4>Ingredients</h4></label>

                <input type="radio" id="preparation" name="tabs">
                <label for="preparation"><h4>Preparation</h4></label>

                <input type="radio" id="notes" name="tabs">
                <label for="notes"><h4>Comments</h4></label>

                <div id="content-ingredients" class="tab-content">
                    <ul>
                        {% for ingredient in dish.Ingredients %}
                            <li>
                                <div class="plaatje">
                                    <img src="assets/img/{{ ingredient.plaatje }}" alt="{{ ingredient.name }}">
                                </div>
                                <div class="ingredient_txt">
                                    <h3>{{ ingredient.name }}</h3>
                                    <p>'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.'</p>
                                    <div class="hoeveelheid">
                                        <h4>Hoeveelheid:</h4>
                                        <p>{{ ingredient.quantity }} {{ ingredient.unit|default('') }}</p>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <div id="content-preparation" class="tab-content">
                    <ol>
                        {% for step in dish.Preparation_steps.preparation_steps|sort((a, b) => a.numberfield <=> b.numberfield) %}
                            <li>{{ step.textfield }}</li>
                        {% endfor %}
                    </ol>
                </div>

                <div id="content-notes" class="tab-content">
                    <ul>
                        {% for comment in dish.Comments.comments %}
                            <li>
                                <div class="Plaatje_user">
                                    <img src="assets/img/{{ comment.user_image }}" alt="{{ comment.user_name }}">
                                </div>
                                <div class="comment_text">
                                    <h3>{{ comment.user_name }}</h3>
                                    <div class="comment_para">
                                        <p>{{ comment.textfield }}</p>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // rating!
        document.addEventListener('DOMContentLoaded', () => {
            const stars = document.querySelectorAll('.interactive-rating .star');
            const ratingMessage = document.getElementById('rating-message');
            const dishId = '{{ dish.id }}';

            // Functie om sterren te vullen op basis van gemiddelde
            function fillStars(average) {
                stars.forEach(star => {
                    const val = parseInt(star.dataset.value);
                    if (val <= average) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
            }

            // Ophalen huidig gemiddelde rating
            function fetchAverageRating() {
                fetch(`indexF.php?action=rating_actions&request_type=average&item_id=${dishId}`)
                    .then(response => {
                        console.log('Response van fetchAverageRating:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Data van fetchAverageRating:', data);
                        if (data.success) {
                            console.log('Type van data.average:', typeof data.average); // Voeg dit toe
                            const average = parseFloat(data.average);
                            fillStars(Math.round(average));
                            ratingMessage.textContent = ``;
                        } else {
                            console.error('Fout bij ophalen gemiddelde:', data.error);
                            ratingMessage.textContent = 'Kon de gemiddelde beoordeling niet ophalen.';
                        }
                    });
            }
            // Initieel ophalen van de gemiddelde rating
            fetchAverageRating();

            // Klik-event op sterren
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = star.dataset.value;

                    fetch(`indexF.php?action=rating_actions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            type: 'rate',
                            item_id: dishId,
                            rating: rating
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const ratingGiven = parseInt(star.dataset.value); // De geklikte rating
                            fillStars(ratingGiven); // Vul de sterren direct met de gegeven rating
                            ratingMessage.textContent = `Je hebt ${ratingGiven} ster(ren) gegeven. Bedankt!`;
                            setTimeout(() => {
                                fetchAverageRating(); // Update het gemiddelde na een korte vertraging
                            }, 2000); // Wacht 2 seconden voordat het gemiddelde weer wordt getoond
                        } else {
                            ratingMessage.textContent = 'Er is iets misgegaan bij het opslaan van je beoordeling.';
                            console.error('Fout bij opslaan rating:', data.error);
                        }
                    })
                    .catch(() => {
                        ratingMessage.textContent = 'Netwerkfout, probeer het opnieuw.';
                    });
                });
            });
        });
    </script>

{% endblock %}